name: Create Git Release

on:
  workflow_call:
    inputs:
      versionNumber:
        description: "Version Number (ie 5.5.0)"
        required: true
        type: string
      dryRun:
        description: "Dry Run"
        type: boolean
        required: false
        default: false
    secrets:
      CICD_APP_ID:
        required: true
      CICD_APP_PRIVATE_KEY:
        required: true
    outputs:
      releaseVersionNumber:
        description: "Release Number Generated by Release Script"
        value: ${{ jobs.create_release.outputs.releaseVersionNumber }}
      releaseUploadUrl:
        description: "Release Upload URL"
        value: ${{ jobs.create_release.outputs.releaseUploadUrl }}

jobs:
  create_release:
    name: "Checkout, Create Release, Create Release Branch, Upload Artifacts ‚ôªÔ∏è"
    if: inputs.dryRun == false
    runs-on: ubuntu-latest
    outputs:
      releaseVersionNumber: ${{ steps.release.outputs.version }}
      releaseUploadUrl: ${{ steps.release_info.outputs.upload_url }}
    steps:
      - name: Get Token from Github CICD Application
        id: cicd-app
        uses: getsentry/action-github-app-token@v3
        with:
          app_id: ${{ secrets.CICD_APP_ID }}
          private_key: ${{ secrets.CICD_APP_PRIVATE_KEY }}

      - name: Checkout
        uses: actions/checkout@v3

      - name: Create new patch release
        id: release
        run: |
          python .github/scripts/release.py ${{ inputs.versionNumber }}
        env:
          GITHUB_TOKEN: ${{ steps.cicd-app.outputs.token }}

      - name: Create Release Branch
        run: |
          git checkout -b release/${{ steps.release.outputs.version }}
          git push origin release/${{ steps.release.outputs.version }}

      - name: Gets latest created release info
        id: release_info
        uses: jossef/action-latest-release-info@v1.2.1
        env:
          GITHUB_TOKEN: ${{ steps.cicd-app.outputs.token }}
  
  dry_run:
    name: "Dry Run ü¶¥"
    if: inputs.dryRun == true
    runs-on: ubuntu-latest
    outputs:
      releaseVersionNumber: "1.0.0"
      releaseUploadUrl: ""
    steps:
      - name: Dry Run
        run: |
          echo "Dry Run"
